<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ì˜ìƒ ê°¤ëŸ¬ë¦¬ - ìƒì„¸ë³´ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            /* ë°˜ì‘í˜• 16:9 ë¹„ìœ¨ ì„¤ì • */
            aspect-ratio: 16 / 9;
        }
        .video-player {
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
            object-fit: cover; /* ì—¬ë°± ì—†ì´ ê½‰ ì°¨ê²Œ */
        }
        .video-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .no-video-message {
            background: #e9ecef;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            color: #6c757d;
        }
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 2rem;
        }
                 .video-error {
             background: #dc3545;
             color: white;
             padding: 20px;
             border-radius: 8px;
             text-align: center;
             margin-top: 10px;
         }
         
         /* ëŒ“ê¸€ ë²„íŠ¼ hover íš¨ê³¼ */
         .comment-actions .btn-link {
             opacity: 0.6;
             transition: opacity 0.2s ease;
         }
         
         .comment-actions .btn-link:hover {
             opacity: 1;
             transform: scale(1.1);
         }
         
         .comment-actions .btn-link.text-warning:hover {
             color: #ffc107 !important;
         }
         
         .comment-actions .btn-link.text-danger:hover {
             color: #dc3545 !important;
         }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” í¬í•¨ -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/posts" class="text-decoration-none"><i class="bi bi-arrow-left"></i> ê°¤ëŸ¬ë¦¬ë¡œ ëŒì•„ê°€ê¸°</a></li>
                    </ol>
                </nav>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="mb-0"><i class="bi bi-play-circle"></i> <span th:text="${post.title}">ì œëª©</span></h2>
                    </div>
                                         <div class="card-body">
                         <div class="row">
                             <div class="col-md-8">
                                 <div th:if="${post.videoFilename != null and post.videoFilename != ''}">
                                     <div class="video-container">
                                         <div id="loadingSpinner" class="loading-spinner">
                                             <i class="bi bi-hourglass-split"></i>
                                             <div>ë¡œë”© ì¤‘...</div>
                                         </div>
                                         <video id="videoPlayer" class="video-player" 
                                                controls 
                                                preload="metadata"
                                                crossorigin="anonymous"
                                                th:src="@{'/files/video/' + ${post.id}}"
                                                th:poster="@{'/files/thumbnail/' + ${post.thumbnailFilename}}"
                                                style="display: none;">
                                             <!-- ì—¬ëŸ¬ í¬ë§· ì§€ì› -->
                                             <source th:src="@{'/files/video/' + ${post.id}}" type="video/mp4">
                                             <source th:src="@{'/files/video/' + ${post.id}}" type="video/webm">
                                             <source th:src="@{'/files/video/' + ${post.id}}" type="video/ogg">
                                             ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                         </video>
                                         <div id="videoError" class="video-error" style="display: none;">
                                             <i class="bi bi-exclamation-triangle"></i>
                                             <h5>ë™ì˜ìƒ ì¬ìƒ ì˜¤ë¥˜</h5>
                                             <p id="errorMessage">ë™ì˜ìƒì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                             <button onclick="retryVideo()" class="btn btn-light btn-sm">
                                                 <i class="bi bi-arrow-clockwise"></i> ë‹¤ì‹œ ì‹œë„
                                             </button>
                                         </div>
                                     </div>
                                     
                                     <div class="video-info mt-3">
                                         <h5><i class="bi bi-info-circle"></i> ë™ì˜ìƒ ì •ë³´</h5>
                                         <div class="row">
                                             <div class="col-md-6">
                                                 <p><strong>íŒŒì¼ëª…:</strong> <span th:text="${post.videoOriginalName}">íŒŒì¼ëª…</span></p>
                                                 <p><strong>í¬ê¸°:</strong> <span th:text="${#numbers.formatDecimal(post.videoSize / 1024 / 1024, 1, 2)}">0</span> MB</p>
                                             </div>
                                             <div class="col-md-6">
                                                 <p><strong>ì¬ìƒ ì‹œê°„:</strong> <span id="duration">ë¡œë”© ì¤‘...</span></p>
                                                 <p><strong>í•´ìƒë„:</strong> <span id="resolution">ë¡œë”© ì¤‘...</span></p>
                                             </div>
                                         </div>
                                         <div class="mt-2">
                                             <a th:href="@{'/files/download/' + ${post.id}}" class="btn btn-primary me-2">
                                                 <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                                             </a>
                                             <button onclick="copyVideoUrl()" class="btn btn-outline-secondary">
                                                 <i class="bi bi-link-45deg"></i> ë§í¬ ë³µì‚¬
                                             </button>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <div th:unless="${post.videoFilename != null and post.videoFilename != ''}" class="no-video-message">
                                     <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                                     <h4 class="mt-3">ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤</h4>
                                     <p>ì´ ê²Œì‹œê¸€ì—ëŠ” ì²¨ë¶€ëœ ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                 </div>
                             </div>
                             
                             <div class="col-md-4">
                                 <div class="card h-100">
                                     <div class="card-header d-flex justify-content-between align-items-center">
                                         <h6 class="mb-0"><i class="bi bi-file-text"></i> ê²Œì‹œê¸€ ì •ë³´</h6>
                                         <div th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.username == post.author.username}">
                                             <a th:href="@{'/posts/' + ${post.id} + '/edit'}" class="btn btn-warning btn-sm me-1">
                                                 <i class="bi bi-pencil"></i> ìˆ˜ì •
                                             </a>
                                             <button onclick="deletePost()" class="btn btn-danger btn-sm">
                                                 <i class="bi bi-trash"></i> ì‚­ì œ
                                             </button>
                                         </div>
                                     </div>
                                     <div class="card-body">
                                         <p><strong>ì‘ì„±ì:</strong> <span th:text="${post.author.fullName}">ì‘ì„±ì</span></p>
                                         <p><strong>ì¡°íšŒìˆ˜:</strong> <span th:text="${post.viewCount}">0</span></p>
                                         <p><strong>ì‘ì„±ì¼:</strong> <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">ë‚ ì§œ</span></p>
                                         <p><strong>ë‚´ìš©:</strong></p>
                                         <div class="border rounded p-3 bg-light">
                                             <span th:text="${post.content}">ë‚´ìš©</span>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
         
         <!-- ëŒ“ê¸€ ì„¹ì…˜ - ì „ì²´ ë„ˆë¹„ë¡œ ì´ë™ -->
         <div class="row mt-4">
             <div class="col-12">
                 <div class="card">
                     <div class="card-header">
                         <h5 class="mb-0"><i class="bi bi-chat-dots"></i> ëŒ“ê¸€</h5>
                     </div>
                     <div class="card-body">
                                                   <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                          <div th:if="${#authorization.expression('isAuthenticated()')}" class="mb-4">
                              <form id="commentForm">
                                  <div class="mb-3">
                                      <textarea class="form-control" id="commentContent" rows="3" 
                                                placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." required></textarea>
                                  </div>
                                  <button type="submit" class="btn btn-primary">
                                      <i class="bi bi-send"></i> ëŒ“ê¸€ ì‘ì„±
                                  </button>
                              </form>
                          </div>
                          <div th:unless="${#authorization.expression('isAuthenticated()')}" class="text-center py-4 border rounded bg-light">
                              <i class="bi bi-chat-dots text-primary mb-3" style="font-size: 2rem;"></i>
                              <h6 class="text-muted mb-2">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h6>
                              <p class="text-muted small mb-3">ë¡œê·¸ì¸í•˜ì‹œë©´ ëŒ“ê¸€ê³¼ ë‹µê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                              <div class="d-flex justify-content-center gap-2">
                                  <a href="/login" class="btn btn-outline-primary btn-sm">
                                      <i class="bi bi-box-arrow-in-right"></i> ë¡œê·¸ì¸
                                  </a>
                                  <a href="/register" class="btn btn-outline-success btn-sm">
                                      <i class="bi bi-person-plus"></i> íšŒì›ê°€ì…
                                  </a>
                              </div>
                          </div>
                         
                         <!-- ëŒ“ê¸€ ëª©ë¡ -->
                         <div id="commentsList" class="mt-4">
                             <div class="text-center text-muted py-4">
                                 <i class="bi bi-hourglass-split"></i>
                                 <p class="mb-0">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        const video = document.getElementById('videoPlayer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const videoError = document.getElementById('videoError');
        const errorMessage = document.getElementById('errorMessage');
        const durationSpan = document.getElementById('duration');
        const resolutionSpan = document.getElementById('resolution');
        
        let retryCount = 0;
        const maxRetries = 3;
        
        if (video) {
            // ë¡œë”© ì‹œì‘
            video.addEventListener('loadstart', () => {
                console.log('â–¶ï¸ ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘');
                showLoading();
            });
            
            // ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ
            video.addEventListener('loadedmetadata', () => {
                console.log('ğŸ“‹ ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                hideLoading();
                showVideo();
                
                // ì¬ìƒ ì‹œê°„ í‘œì‹œ
                if (video.duration && !isNaN(video.duration)) {
                    const minutes = Math.floor(video.duration / 60);
                    const seconds = Math.floor(video.duration % 60);
                    durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // í•´ìƒë„ í‘œì‹œ
                if (video.videoWidth && video.videoHeight) {
                    resolutionSpan.textContent = `${video.videoWidth} Ã— ${video.videoHeight}`;
                }
            });
            
            // ì¬ìƒ ê°€ëŠ¥
            video.addEventListener('canplay', () => {
                console.log('âœ… ë¹„ë””ì˜¤ ì¬ìƒ ê°€ëŠ¥');
                hideLoading();
                showVideo();
            });
            
            // ì¬ìƒ ì‹œì‘
            video.addEventListener('play', () => {
                console.log('â–¶ï¸ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘');
                hideError();
            });
            
            // ì¼ì‹œì •ì§€
            video.addEventListener('pause', () => {
                console.log('â¸ï¸ ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ë‹¨');
            });
            
            // ì¬ìƒ ì™„ë£Œ
            video.addEventListener('ended', () => {
                console.log('ğŸ ë¹„ë””ì˜¤ ì¬ìƒ ì™„ë£Œ');
            });
            
            // ë¡œë”© ì¤‘ë‹¨
            video.addEventListener('abort', () => {
                console.log('âŒ ë¹„ë””ì˜¤ ë¡œë“œ ì¤‘ë‹¨');
                hideLoading();
                showError('ë™ì˜ìƒ ë¡œë“œê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
            
            // ë¡œë”© ì§€ì—°
            video.addEventListener('stalled', () => {
                console.log('â³ ë¹„ë””ì˜¤ ë¡œë“œ ì§€ì—°');
                showLoading();
            });
            
            // ëŒ€ê¸° ìƒíƒœ
            video.addEventListener('waiting', () => {
                console.log('â³ ë¹„ë””ì˜¤ ë²„í¼ë§ ì¤‘');
                showLoading();
            });
            
            // ì¬ìƒ ì¬ê°œ
            video.addEventListener('playing', () => {
                console.log('â–¶ï¸ ë¹„ë””ì˜¤ ì¬ìƒ ì¬ê°œ');
                hideLoading();
            });
            
            // ì—ëŸ¬ ì²˜ë¦¬
            video.addEventListener('error', (e) => {
                console.error('âŒ ë¹„ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:', e);
                hideLoading();
                
                let errorMsg = 'ë™ì˜ìƒì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                
                if (video.error) {
                    console.error('âŒ ë¹„ë””ì˜¤ ì˜¤ë¥˜ ì½”ë“œ:', video.error.code);
                    console.error('âŒ ë¹„ë””ì˜¤ ì˜¤ë¥˜ ë©”ì‹œì§€:', video.error.message);
                    
                    switch (video.error.code) {
                        case 1: // MEDIA_ERR_ABORTED
                            errorMsg = 'ë™ì˜ìƒ ë¡œë“œê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
                            break;
                        case 2: // MEDIA_ERR_NETWORK
                            errorMsg = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë™ì˜ìƒì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                            break;
                        case 3: // MEDIA_ERR_DECODE
                            errorMsg = 'ë™ì˜ìƒ íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì…ë‹ˆë‹¤.';
                            break;
                        case 4: // MEDIA_ERR_SRC_NOT_SUPPORTED
                            errorMsg = 'ì§€ì›í•˜ì§€ ì•ŠëŠ” ë™ì˜ìƒ í˜•ì‹ì´ê±°ë‚˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                            break;
                    }
                }
                
                console.error('âŒ ë¹„ë””ì˜¤ src:', video.src);
                console.error('âŒ ë¹„ë””ì˜¤ currentSrc:', video.currentSrc);
                
                showError(errorMsg);
            });
            
            // ì´ˆê¸° ë¡œë“œ ì‹œë„
            video.load();
        }
        
        function showLoading() {
            loadingSpinner.style.display = 'block';
            video.style.display = 'none';
            videoError.style.display = 'none';
        }
        
        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }
        
        function showVideo() {
            video.style.display = 'block';
            videoError.style.display = 'none';
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            videoError.style.display = 'block';
            video.style.display = 'none';
            loadingSpinner.style.display = 'none';
        }
        
        function hideError() {
            videoError.style.display = 'none';
        }
        
        function retryVideo() {
            retryCount++;
            if (retryCount <= maxRetries) {
                console.log(`ğŸ”„ ë™ì˜ìƒ ì¬ì‹œë„ ${retryCount}/${maxRetries}`);
                hideError();
                showLoading();
                
                // ì ê¹ ê¸°ë‹¤ë¦° í›„ ì¬ì‹œë„
                setTimeout(() => {
                    video.load();
                }, 1000);
            } else {
                showError('ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
            }
        }
        
        function copyVideoUrl() {
            const videoUrl = video.src;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(videoUrl).then(() => {
                    // ì„ì‹œ ì•Œë¦¼ í‘œì‹œ
                    const btn = event.target;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check"></i> ë³µì‚¬ë¨!';
                    btn.classList.add('btn-success');
                    btn.classList.remove('btn-outline-secondary');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-secondary');
                    }, 2000);
                }).catch(() => {
                    alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            } else {
                // í´ë°±: í…ìŠ¤íŠ¸ ì„ íƒ
                const textArea = document.createElement('textarea');
                textArea.value = videoUrl;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (err) {
                    alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                document.body.removeChild(textArea);
            }
        }
        
        function deletePost() {
            if (confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const postId = /*[[${post.id}]]*/ '';
                fetch(`/posts/${postId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/posts';
                    } else {
                        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            }
        }
        
                 // ëŒ“ê¸€ ê´€ë ¨ ê¸°ëŠ¥
         const commentForm = document.getElementById('commentForm');
         const commentContent = document.getElementById('commentContent');
         const commentsList = document.getElementById('commentsList');
         
         // ëŒ“ê¸€ ì‘ì„± í¼ì´ ìˆì„ ë•Œë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ)
         if (commentForm) {
             commentForm.addEventListener('submit', function(e) {
                 e.preventDefault();
                 
                 const content = commentContent.value.trim();
                 if (!content) {
                     alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                     return;
                 }
                 
                 const postId = /*[[${post.id}]]*/ '';
                 
                 fetch(`/api/comments`, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({
                         postId: postId,
                         content: content
                     })
                 })
                 .then(response => {
                     if (response.ok) {
                         return response.json();
                     } else {
                         throw new Error('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                     }
                 })
                 .then(data => {
                     commentContent.value = '';
                     loadComments();
                     alert('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                 })
                 .catch(error => {
                     console.error('Error:', error);
                     alert(error.message);
                 });
             });
         }
        
                 function loadComments() {
             const postId = /*[[${post.id}]]*/ '';
             
             fetch(`/api/comments/${postId}`)
             .then(response => {
                 if (!response.ok) {
                     throw new Error('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                 }
                 return response.json();
             })
             .then(comments => {
                 displayComments(comments);
             })
             .catch(error => {
                 console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                 commentsList.innerHTML = `
                     <div class="text-center text-danger py-3">
                         <i class="bi bi-exclamation-triangle"></i>
                         <p class="mb-0">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                         <small>${error.message}</small>
                     </div>
                 `;
             });
         }
        
                 function displayComments(comments) {
             if (comments.length === 0) {
                 commentsList.innerHTML = `
                     <div class="text-center text-muted py-3">
                         <i class="bi bi-chat-dots"></i>
                         <p class="mb-0">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                     </div>
                 `;
                 return;
             }
             
             const commentsHtml = comments.map(comment => {
                 return renderComment(comment, 0);
             }).join('');
             
             commentsList.innerHTML = commentsHtml;
         }
         
         // ì¬ê·€ì ìœ¼ë¡œ ëŒ“ê¸€ê³¼ ë‹µê¸€ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         function renderComment(comment, depth) {
             const currentUser = /*[[(#authentication != null and #authentication.principal != 'anonymousUser' ? #authentication.principal.username : '')]]*/ '';
             const isLoggedIn = currentUser && currentUser !== '';
             const isAuthor = currentUser === comment.authorUsername;
             
             // ë””ë²„ê¹…ìš© ë¡œê·¸
             console.log('ëŒ“ê¸€ ì •ë³´:', {
                 commentId: comment.id,
                 authorName: comment.authorName,
                 authorUsername: comment.authorUsername,
                 currentUser: currentUser,
                 isLoggedIn: isLoggedIn,
                 isAuthor: isAuthor
             });
             
             // ë“¤ì—¬ì“°ê¸° ê³„ì‚° ìˆ˜ì • - ê° ê¹Šì´ë³„ë¡œ ëª…í™•í•œ í´ë˜ìŠ¤ ì„¤ì •
             let indentClass = '';
             if (depth === 1) indentClass = 'ms-3';
             else if (depth === 2) indentClass = 'ms-5';
             else if (depth === 3) indentClass = 'ms-7';
             else if (depth >= 4) indentClass = 'ms-9';
             
             const borderClass = depth > 0 ? 'border-start ps-3' : '';
             const borderStyle = depth > 0 ? `border-left: 3px solid #dee2e6;` : '';
             const arrowPrefix = depth > 0 ? 'â†³ '.repeat(depth) : '';
             const textColor = depth > 0 ? 'text-primary' : '';
             
                           return `
                 <div class="comment-item ${depth === 0 ? 'border-bottom' : ''} pb-3 mb-3 ${indentClass}">
                <div class="d-flex justify-content-between align-items-start ${borderClass}" style="${borderStyle}">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <strong class="me-2 ${textColor}">${arrowPrefix}${comment.authorName}</strong>
                            <small class="text-muted">${new Date(comment.createdAt).toLocaleString()}</small>
                        </div>
                        <div id="commentContent${comment.id}" class="comment-content">
                            <p class="mb-2">${comment.content}</p>
                        </div>
                        <div id="editForm${comment.id}" class="edit-form" style="display: none;">
                            <textarea class="form-control mb-2" id="editContent${comment.id}" rows="2" 
                                      placeholder="ëŒ“ê¸€ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”...">${comment.content}</textarea>
                            <button onclick="submitEdit(${comment.id})" class="btn btn-primary btn-sm me-2">
                                <i class="bi bi-check"></i> ìˆ˜ì • ì™„ë£Œ
                            </button>
                            <button onclick="hideEditForm(${comment.id})" class="btn btn-outline-secondary btn-sm">
                                ì·¨ì†Œ
                            </button>
                        </div>
                        <div class="d-flex align-items-center comment-actions">
                            ${isLoggedIn ? `
                                <button onclick="showReplyForm(${comment.id})" class="btn btn-link btn-sm p-0 me-3 text-decoration-none">
                                    <i class="bi bi-reply"></i> ë‹µê¸€
                                </button>
                            ` : `
                                <small class="text-muted me-3">
                                    <i class="bi bi-info-circle"></i> ë‹µê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤
                                </small>
                            `}
                            ${isAuthor ? `
                                <button onclick="editComment(${comment.id})" class="btn btn-link btn-sm p-0 me-2 text-decoration-none text-warning">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button onclick="deleteComment(${comment.id})" class="btn btn-link btn-sm p-0 text-decoration-none text-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                ${comment.replies && comment.replies.length > 0 ? `
                    <div class="replies-container mt-3">
                        ${comment.replies.map(reply => renderComment(reply, depth + 1)).join('')}
                    </div>
                ` : ''}
                
                ${isLoggedIn ? `
                    <div id="replyForm${comment.id}" class="reply-form mt-2" style="display: none;">
                        <textarea class="form-control mb-2" id="replyContent${comment.id}" rows="2" 
                                  placeholder="ë‹µê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                        <button onclick="submitReply(${comment.id})" class="btn btn-primary btn-sm me-2">
                            <i class="bi bi-send"></i> ë‹µê¸€ ì‘ì„±
                        </button>
                        <button onclick="hideReplyForm(${comment.id})" class="btn btn-outline-secondary btn-sm">
                            ì·¨ì†Œ
                        </button>
                    </div>
                ` : ''}
            </div>
             `;
         }
        
                 function showReplyForm(commentId) {
             const replyForm = document.getElementById(`replyForm${commentId}`);
             const editForm = document.getElementById(`editForm${commentId}`);
             
             // ë‹¤ë¥¸ í¼ë“¤ ìˆ¨ê¸°ê¸°
             hideAllForms();
             
             // ë‹µê¸€ í¼ í‘œì‹œ
             replyForm.style.display = 'block';
         }
        
        function hideReplyForm(commentId) {
            const replyForm = document.getElementById(`replyForm${commentId}`);
            replyForm.style.display = 'none';
        }
        
        function submitReply(commentId) {
            const content = document.getElementById(`replyContent${commentId}`).value.trim();
            if (!content) {
                alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const postId = /*[[${post.id}]]*/ '';
            
            fetch(`/api/comments/${commentId}/replies`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    postId: postId,
                    content: content
                })
            })
            .then(response => {
                if (response.ok) {
                    hideReplyForm(commentId);
                    loadComments();
                    alert('ë‹µê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    throw new Error('ë‹µê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        }
        
                 function deleteComment(commentId) {
             if (confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•˜ìœ„ ë‹µê¸€ë“¤ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
                 fetch(`/api/comments/${commentId}`, {
                     method: 'DELETE'
                 })
                 .then(response => {
                     if (response.ok) {
                         loadComments();
                         alert('ëŒ“ê¸€ê³¼ í•˜ìœ„ ë‹µê¸€ë“¤ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                     } else {
                         throw new Error('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                     }
                 })
                 .catch(error => {
                     console.error('Error:', error);
                     alert(error.message);
                 });
             }
         }
         
                   // ëŒ“ê¸€ ìˆ˜ì • í¼ í‘œì‹œ
          function editComment(commentId) {
              const editForm = document.getElementById(`editForm${commentId}`);
              const commentContent = document.getElementById(`commentContent${commentId}`);
              const replyForm = document.getElementById(`replyForm${commentId}`);
              
              // ë‹¤ë¥¸ í¼ë“¤ ìˆ¨ê¸°ê¸°
              hideAllForms();
              
              // ëŒ“ê¸€ ë‚´ìš© ìˆ¨ê¸°ê³  ìˆ˜ì • í¼ í‘œì‹œ
              commentContent.style.display = 'none';
              editForm.style.display = 'block';
          }
          
          // ìˆ˜ì • í¼ ìˆ¨ê¸°ê¸°
          function hideEditForm(commentId) {
              const editForm = document.getElementById(`editForm${commentId}`);
              const commentContent = document.getElementById(`commentContent${commentId}`);
              
              // ìˆ˜ì • í¼ ìˆ¨ê¸°ê³  ëŒ“ê¸€ ë‚´ìš© í‘œì‹œ
              editForm.style.display = 'none';
              commentContent.style.display = 'block';
          }
         
         // ëŒ“ê¸€ ìˆ˜ì • ì œì¶œ
         function submitEdit(commentId) {
             const content = document.getElementById(`editContent${commentId}`).value.trim();
             if (!content) {
                 alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                 return;
             }
             
             fetch(`/api/comments/${commentId}`, {
                 method: 'PUT',
                 headers: {
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify({
                     content: content
                 })
             })
             .then(response => {
                 if (response.ok) {
                     hideEditForm(commentId);
                     loadComments();
                     alert('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                 } else {
                     throw new Error('ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                 }
             })
             .catch(error => {
                 console.error('Error:', error);
                 alert(error.message);
             });
         }
         
                   // ëª¨ë“  í¼ ìˆ¨ê¸°ê¸°
          function hideAllForms() {
              const replyForms = document.querySelectorAll('.reply-form');
              const editForms = document.querySelectorAll('.edit-form');
              const commentContents = document.querySelectorAll('.comment-content');
              
              replyForms.forEach(form => form.style.display = 'none');
              editForms.forEach(form => form.style.display = 'none');
              commentContents.forEach(content => content.style.display = 'block');
          }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            loadComments();
        });
    </script>
</body>
</html>